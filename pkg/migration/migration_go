// Copyright 2018 cloudy 272685110@qq.com.  All rights reserved.
// Use of this source code is governed by a MIT style
// license that can be found in the LICENSE file.
package migration

import (
	"github.com/hashicorp/go-version"
	"github.com/itcloudy/base-framework/pkg/consts"
	"github.com/itcloudy/base-framework/pkg/logs"
	"github.com/itcloudy/base-framework/pkg/models"
	"go.uber.org/zap"
)

type database interface {
	CurrentVersion() (string, error)
	ApplyMigration(string, string) error
}

func migrate(db database, appVer *version.Version, migrations []*models.MigrationHistory) error {
	dbVerString, err := db.CurrentVersion()
	if err != nil {
		logs.Logger.Error("get migrate version failed", zap.Error(err))
		return err
	}

	dbVer, err := version.NewVersion(dbVerString)
	if err != nil {
		logs.Logger.Error("parse version failed", zap.Error(err), zap.String("version", dbVerString))

		return err
	}

	// if the database version is up-to-date
	if !dbVer.LessThan(appVer) {
		return nil
	}

	for _, m := range migrations {
		mgrVer, err := version.NewVersion(m.Version)
		if err != nil {
			logs.Logger.Error("parse version failed", zap.Error(err), zap.String("version", m.Version))
			return err
		}
		if !dbVer.LessThan(mgrVer) {
			continue
		}
		err = db.ApplyMigration(m.Version, m.Data)
		if err != nil {
			logs.Logger.Error("apply migration failed", zap.Error(err), zap.String("version", m.Version))

			return err
		}
		logs.Logger.Info("apply migration success", zap.String("version", m.Version))
	}

	return nil
}

func runMigrations(db database, migrationList []*models.MigrationHistory) error {
	appVer, err := version.NewVersion(consts.VERSION)
	if err != nil {
		logs.Logger.Error("parse version failed", zap.Error(err))

		return err
	}
	return migrate(db, appVer, migrationList)
}

// InitMigrate applies initial migrations
func InitMigrate() error {
	return runMigrations(db, AllInitMigrations)
}

// UpdateMigrate applies update migrations
func UpdateMigrate(db database) error {
	return runMigrations(db, updateMigrations)
}
